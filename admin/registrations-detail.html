<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报名管理 - 学员报名管理系统</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">报名管理系统</div>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="users.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            用户管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="blacklist.html" class="nav-link">
                            <i class="fas fa-ban"></i>
                            黑名单管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="projects.html" class="nav-link">
                            <i class="fas fa-project-diagram"></i>
                            项目管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="classes.html" class="nav-link">
                            <i class="fas fa-graduation-cap"></i>
                            班型管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="discounts.html" class="nav-link">
                            <i class="fas fa-percent"></i>
                            优惠管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="registrations-projects.html" class="nav-link active">
                            <i class="fas fa-file-alt"></i>
                            报名管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="positions-projects.html" class="nav-link">
                            <i class="fas fa-briefcase"></i>
                            招考岗位管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="accounts.html" class="nav-link">
                            <i class="fas fa-user-cog"></i>
                            账号管理
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content" style="max-width: 100%; overflow-x: hidden;">
            <!-- 页面头部 -->
            <div class="page-header">
                <div class="page-breadcrumb">
                    <a href="registrations-projects.html" class="breadcrumb-link">
                        <i class="fas fa-arrow-left"></i>
                        返回项目列表
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current" id="currentProjectName">报名管理</span>
                </div>
                <h1 class="page-title" id="pageTitle">报名管理</h1>
                <p class="page-subtitle" id="pageSubtitle">查看和管理用户报名信息及审核状态</p>
                <div class="user-info">
                    <button class="user-action-btn user-profile-btn" type="button" onclick="showProfileModal()">
                        <i class="fas fa-id-card"></i>
                        个人信息
                    </button>
                    <button class="user-name-btn" type="button" onclick="logout()">
                        <span id="currentUserDisplay" data-role="current-username">用户名</span>
                    </button>
                </div>
            </div>

            <!-- 工具栏 -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn btn-success" onclick="exportRegistrations()">
                        <i class="fas fa-download"></i> 导出数据
                    </button>
                    <button class="btn btn-info" onclick="batchApprove()" id="batchApproveBtn" disabled>
                        <i class="fas fa-check"></i> 批量审核
                    </button>
                </div>
                <div class="toolbar-right">
                    <select class="form-select" style="width: 150px;" onchange="filterRegistrations()" id="projectFilter">
                        <option value="">全部项目</option>
                    </select>
                    <select class="form-select" style="width: 150px;" onchange="filterRegistrations()" id="classFilter">
                        <option value="">全部班型</option>
                    </select>
                    <select class="form-select" style="width: 120px;" onchange="filterRegistrations()" id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="pending">待审核</option>
                        <option value="approved">已通过</option>
                        <option value="rejected">已拒绝</option>
                        <option value="paid">已缴费</option>
                    </select>
                    <input type="text" class="search-box" placeholder="搜索姓名/手机号/微信号" id="searchInput" onkeyup="handleSearchKeyup(event)">
                    <button class="btn btn-secondary" onclick="searchRegistrations()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                </div>
            </div>

            <!-- 数据看板 -->
            <div class="stats-dashboard">
                <div class="stats-card">
                    <div class="stats-update-time" id="totalRegistrationsTime">刚刚</div>
                    <div class="stats-number" id="totalRegistrations">0</div>
                    <div class="stats-label">总报名数</div>
                    <div class="stats-description">所有用户提交的报名申请总数</div>
                </div>
                <div class="stats-card">
                    <div class="stats-update-time" id="pendingRegistrationsTime">刚刚</div>
                    <div class="stats-number" id="pendingRegistrations">0</div>
                    <div class="stats-label">待审核</div>
                    <div class="stats-description">等待管理员审核的报名申请</div>
                </div>
                <div class="stats-card">
                    <div class="stats-update-time" id="approvedRegistrationsTime">刚刚</div>
                    <div class="stats-number" id="approvedRegistrations">0</div>
                    <div class="stats-label">已通过</div>
                    <div class="stats-description">审核通过的有效报名数量</div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="data-table">
                <div class="table-responsive" style="overflow-x: auto; max-width: 100%; border: 1px solid #e9ecef; border-radius: 8px;">
                    <table class="table" style="min-width: 2200px; margin-bottom: 0;">
                        <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                            <tr>
                                <th style="width: 50px; min-width: 50px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th style="width: 80px; min-width: 80px;">报名ID</th>
                                <th style="width: 100px; min-width: 100px;">姓名</th>
                                <th style="width: 100px; min-width: 100px;">微信号</th>
                                <th style="width: 120px; min-width: 120px;">手机号</th>
                                <th style="width: 140px; min-width: 140px;">身份证</th>
                                <th style="width: 100px; min-width: 100px;">岗位代码</th>
                                <th style="width: 150px; min-width: 150px;">岗位名称</th>
                                <th style="width: 80px; min-width: 80px;">招录人数</th>
                                <th style="width: 80px; min-width: 80px;">笔试排名</th>
                                <th style="width: 80px; min-width: 80px;">大中小围</th>
                                <th style="width: 140px; min-width: 140px;">所报班型</th>
                                <th style="width: 100px; min-width: 100px;">协议/非协议</th>
                                <th style="width: 160px; min-width: 160px;">所享优惠</th>
                                <th style="width: 80px; min-width: 80px;">优惠金额</th>
                                <th style="width: 100px; min-width: 100px;">推荐老学员</th>
                                <th style="width: 80px; min-width: 80px;">应收学费</th>
                                <th style="width: 100px; min-width: 100px;">笔试成绩</th>
                                <th style="width: 100px; min-width: 100px;">转账截图</th>
                                <th style="width: 100px; min-width: 100px;">审核状态</th>
                                <th style="width: 140px; min-width: 140px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="registrationTableBody">
                            <!-- 数据行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination" style="justify-content: flex-end;">
                <div class="pagination-info">
                    显示第 <span id="startRecord">1</span> 至 <span id="endRecord">10</span> 项，共 <span id="totalRecords">0</span> 项
                </div>
                <div>
                    <a href="#" class="pagination-btn" onclick="changePage('prev')" id="prevBtn">上一页</a>
                    <a href="#" class="pagination-btn active" onclick="changePage(1)">1</a>
                    <a href="#" class="pagination-btn" onclick="changePage(2)">2</a>
                    <a href="#" class="pagination-btn" onclick="changePage(3)">3</a>
                    <a href="#" class="pagination-btn" onclick="changePage('next')" id="nextBtn">下一页</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑报名模态框 -->
    <div id="registrationModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="registrationModalTitle">新增报名</h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registrationForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">学员姓名 <span class="form-required">*</span></label>
                            <input type="text" class="form-control" id="studentName" required placeholder="请输入学员姓名">
                        </div>
                        <div class="form-group">
                            <label class="form-label">手机号 <span class="form-required">*</span></label>
                            <input type="tel" class="form-control" id="phone" required 
                                   pattern="^1[3-9]\d{9}$" placeholder="请输入手机号">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">身份证号 <span class="form-required">*</span></label>
                            <input type="text" class="form-control" id="idCard" required placeholder="请输入身份证号">
                        </div>
                        <div class="form-group">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="email" placeholder="请输入邮箱地址">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">报名项目 <span class="form-required">*</span></label>
                            <select class="form-select" id="projectId" required onchange="loadProjectClasses()">
                                <option value="">请选择项目</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">选择班型 <span class="form-required">*</span></label>
                            <select class="form-select" id="classId" required onchange="calculateFee()">
                                <option value="">请先选择项目</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">学历</label>
                            <select class="form-select" id="education">
                                <option value="">请选择学历</option>
                                <option value="高中">高中</option>
                                <option value="大专">大专</option>
                                <option value="本科">本科</option>
                                <option value="硕士">硕士</option>
                                <option value="博士">博士</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">工作单位</label>
                            <input type="text" class="form-control" id="workplace" placeholder="请输入工作单位">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">通讯地址</label>
                        <input type="text" class="form-control" id="address" placeholder="请输入详细地址">
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注信息</label>
                        <textarea class="form-control form-textarea" id="remarks" 
                                  placeholder="其他需要说明的信息"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">应缴费用</label>
                            <input type="number" class="form-control" id="totalFee" readonly placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">优惠金额</label>
                            <input type="number" class="form-control" id="discountAmount" 
                                   min="0" step="0.01" placeholder="0.00" onchange="calculateFee()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">实缴费用</label>
                            <input type="number" class="form-control" id="actualFee" readonly placeholder="0.00">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">审核状态</label>
                            <select class="form-select" id="status">
                                <option value="pending">待审核</option>
                                <option value="approved">已通过</option>
                                <option value="rejected">已拒绝</option>
                                <option value="paid">已缴费</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">缴费状态</label>
                            <select class="form-select" id="paymentStatus">
                                <option value="unpaid">未缴费</option>
                                <option value="partial">部分缴费</option>
                                <option value="paid">已缴费</option>
                                <option value="refunded">已退费</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRegistrationModal()">取消</button>
                <button class="btn btn-primary" onclick="saveRegistration()">保存</button>
            </div>
        </div>
    </div>

    <!-- 查看/编辑详情模态框 -->
    <div id="detailModal" class="modal">
        <div class="modal-content" style="max-width: 1100px; max-height: 95vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title" id="detailModalTitle">报名详情</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 15px 20px;">
                <form id="detailForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 第一行 -->
                        <div class="form-group">
                            <label class="form-label">报名ID</label>
                            <input type="text" class="form-control" id="detailId" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">微信OpenID</label>
                            <input type="text" class="form-control" id="detailOpenId" readonly style="background: #f5f5f5; font-family: monospace; font-size: 12px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">学员姓名 <span class="form-required">*</span></label>
                            <input type="text" class="form-control" id="detailStudentName" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- 第二行 -->
                        <div class="form-group">
                            <label class="form-label">微信号 <span class="form-required">*</span></label>
                            <input type="text" class="form-control" id="detailWechat" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="detailPhone" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 第三行 -->
                        <div class="form-group">
                            <label class="form-label">岗位代码</label>
                            <input type="text" class="form-control" id="detailPositionCode" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">岗位名称</label>
                            <input type="text" class="form-control" id="detailPositionName" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">招录人数</label>
                            <input type="number" class="form-control" id="detailRecruitCount" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 第四行 -->
                        <div class="form-group">
                            <label class="form-label">笔试排名</label>
                            <input type="number" class="form-control" id="detailWrittenRank" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">大中小围</label>
                            <input type="text" class="form-control" id="detailRankCategory" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">所报班型 <span class="form-required">*</span></label>
                            <input type="text" class="form-control" id="detailClassName" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 第五行 -->
                        <div class="form-group">
                            <label class="form-label">协议/非协议</label>
                            <select class="form-select" id="detailIsAgreement">
                                <option value="协议">协议</option>
                                <option value="非协议">非协议</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">所享优惠</label>
                            <select class="form-select" id="detailDiscountSelect" onchange="updateDiscountAmount()">
                                <option value="">请选择优惠</option>
                                <option value="守擂优惠" data-amount="800">守擂优惠 (¥800)</option>
                                <option value="老学员优惠" data-amount="500">老学员优惠 (¥500)</option>
                                <option value="组团优惠" data-amount="600">组团优惠 (¥600)</option>
                                <option value="早鸟优惠" data-amount="300">早鸟优惠 (¥300)</option>
                                <option value="新人优惠" data-amount="200">新人优惠 (¥200)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">优惠金额</label>
                            <input type="number" class="form-control" id="detailDiscountAmount" readonly style="background: #f5f5f5;" min="0" step="0.01">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 第六行 -->
                        <div class="form-group">
                            <label class="form-label">推荐老学员</label>
                            <input type="text" class="form-control" id="detailReferrerName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">应收学费</label>
                            <input type="number" class="form-control" id="detailTotalFee" readonly style="background: #f5f5f5;" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">实际学费</label>
                            <input type="number" class="form-control" id="detailActualFee" min="0" step="0.01">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- 第七行 -->
                        <div class="form-group">
                            <label class="form-label">审核状态</label>
                            <select class="form-select" id="detailStatus">
                                <option value="pending">待审核</option>
                                <option value="approved">已审核</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">缴费状态</label>
                            <select class="form-select" id="detailPaymentStatus">
                                <option value="unpaid">未缴费</option>
                                <option value="paid">已缴费</option>
                                <option value="partial">已缴定金</option>
                                <option value="refunded">已退费</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注描述</label>
                        <textarea class="form-control form-textarea" id="detailRemarks" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- 图片查看区域 -->
                        <div class="form-group">
                            <label class="form-label">身份证图片</label>
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center;">
                                <img id="detailIdCardImage" src="" style="max-width: 100%; max-height: 120px; cursor: pointer;" onclick="viewImage(this.src, '身份证图片')">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">笔试成绩图片</label>
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center;">
                                <img id="detailWrittenScoreImage" src="" style="max-width: 100%; max-height: 120px; cursor: pointer;" onclick="viewImage(this.src, '笔试成绩图片')">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">转账截图</label>
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center;">
                                <img id="detailPaymentImage" src="" style="max-width: 100%; max-height: 120px; cursor: pointer;" onclick="viewImage(this.src, '转账截图')">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="flex-shrink: 0; background: white; border-top: 1px solid #dee2e6;">
                <button class="btn btn-secondary" onclick="closeDetailModal()">取消</button>
                <button class="btn btn-primary" onclick="saveDetailChanges()">保存修改</button>
                <div style="margin-left: 20px;">
                    <button class="btn btn-success" onclick="approveFromDetail()" id="approveDetailBtn" style="display: none;">审核通过</button>
                    <button class="btn btn-warning" onclick="rejectFromDetail()" id="rejectDetailBtn" style="display: none;">审核拒绝</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">导入报名数据</h3>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-upload" onclick="selectImportFile()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                    <div class="file-upload-text">点击选择Excel文件或拖拽到此处</div>
                    <div style="font-size: 12px; color: #999; margin-top: 10px;">
                        支持.xlsx/.xls格式，文件大小不超过10MB
                    </div>
                </div>
                <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="handleImportFile(event)">
                
                <div id="importPreview" style="display: none; margin-top: 20px;">
                    <h4>导入预览</h4>
                    <div id="importSummary"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <h5>导入说明：</h5>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px; color: #666;">
                        <li>Excel第一行应为列标题：姓名、手机号、身份证号、邮箱、项目名称、班型名称</li>
                        <li>姓名、手机号、身份证号为必填项</li>
                        <li>项目名称和班型名称必须在系统中存在</li>
                        <li>重复身份证号将被跳过</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button class="btn btn-primary" id="importBtn" onclick="importRegistrations()" disabled>开始导入</button>
            </div>
        </div>
    </div>

    <script src="js/user.js"></script>
    <script>
        // 全局变量
        let currentPage = 1;
        let pageSize = 10;
        let totalItems = 0;
        let allRegistrations = [];
        let filteredRegistrations = [];
        let editingRegistrationId = null;
        let allProjects = [];
        let allClasses = [];

        // 读取URL参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面DOM加载完成');
            try {
                // 处理URL参数并更新页面标题
                const projectName = getQueryParam('projectName');
                if (projectName) {
                    document.getElementById('currentProjectName').textContent = projectName;
                    document.getElementById('pageTitle').textContent = `${projectName} - 报名管理`;
                    document.getElementById('pageSubtitle').textContent = `当前项目：${projectName}，可查看和管理报名数据`;
                }
                
                loadProjects();
                loadClasses();
                loadRegistrations();
                console.log('初始化完成');
            } catch (error) {
                console.error('初始化过程中发生错误:', error);
                alert('页面初始化失败，请刷新页面重试');
            }
        });

        // 全局错误处理器
        window.addEventListener('error', function(event) {
            console.error('JavaScript错误:', event.error);
            console.error('错误文件:', event.filename);
            console.error('错误行号:', event.lineno);
        });

        // 添加点击事件的调试信息
        document.addEventListener('click', function(event) {
            if (event.target.closest('.btn')) {
                console.log('按钮点击事件:', event.target);
                console.log('按钮onclick属性:', event.target.getAttribute('onclick'));
            }
        });

        // 模拟项目数据
        function generateMockProjects() {
            return [
                { id: 1, name: '2024年选调生培训', type: '选调生' },
                { id: 2, name: '2024年省考培训', type: '省考' },
                { id: 3, name: '2024年申论专项培训', type: '申论' },
                { id: 4, name: '2024年国考培训', type: '国考' },
                { id: 5, name: '2024年事业单位培训', type: '事业单位' }
            ];
        }

        // 模拟班型数据
        function generateMockClasses() {
            const classTypes = ['普通班', 'VIP班', '强化班', '周末班', '网络班'];
            const projects = generateMockProjects();
            const mockData = [];
            
            projects.forEach(project => {
                classTypes.forEach((type, index) => {
                    mockData.push({
                        id: project.id * 10 + index + 1,
                        name: `${project.name} ${type}`,
                        projectId: project.id,
                        projectName: project.name,
                        fee: Math.floor(Math.random() * 3000) + 1000,
                        type: type
                    });
                });
            });
            return mockData;
        }

        // 生成随机优惠标签
        function getRandomDiscounts() {
            const allDiscounts = ['守擂优惠', '老学员优惠', '组团优惠', '早鸟优惠', '新人优惠', '推荐优惠'];
            const count = Math.floor(Math.random() * 3); // 0-2个优惠
            const selectedDiscounts = [];
            
            for (let i = 0; i < count; i++) {
                const randomDiscount = allDiscounts[Math.floor(Math.random() * allDiscounts.length)];
                if (!selectedDiscounts.includes(randomDiscount)) {
                    selectedDiscounts.push(randomDiscount);
                }
            }
            
            return selectedDiscounts;
        }

        // 模拟报名数据
        function generateMockRegistrations() {
            const names = ['张三', '李四', '王五', '赵六', '孙七', '周八', '吴九', '郑十', '刘一', '陈二'];
            const educations = ['高中', '大专', '本科', '硕士', '博士'];
            const statuses = ['pending', 'approved', 'rejected', 'paid'];
            const paymentStatuses = ['unpaid', 'partial', 'paid', 'refunded'];
            const mockData = [];
            
            for (let i = 1; i <= 50; i++) {
                const registrationTime = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const project = allProjects[Math.floor(Math.random() * allProjects.length)];
                const projectClasses = allClasses.filter(c => c.projectId === project.id);
                const selectedClass = projectClasses[Math.floor(Math.random() * projectClasses.length)];
                const discountAmount = Math.random() > 0.7 ? Math.floor(Math.random() * 500) : 0;
                const actualFee = selectedClass.fee - discountAmount;
                
                mockData.push({
                    id: i,
                    openid: `wx_${Math.random().toString(36).substr(2, 9)}_${Math.random().toString(36).substr(2, 6)}`,
                    studentName: names[Math.floor(Math.random() * names.length)] + i,
                    phone: `138${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`,
                    wechat: `user_${Math.random().toString(36).substr(2, 8)}`,
                    idCard: `1101${(1950 + Math.floor(Math.random() * 50)).toString()}${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
                    idCardImage: `/images/id_card_${i}.jpg`, // 模拟身份证图片路径
                    paymentImage: `/images/payment_${i}.jpg`, // 模拟转账截图路径
                    positionCode: `POS${(1000 + i).toString()}`,
                    positionName: `${project.type}岗位${i}号`,
                    recruitCount: Math.floor(Math.random() * 10) + 1, // 招录人数 1-10
                    writtenRank: Math.random() > 0.3 ? Math.floor(Math.random() * 200) + 1 : null, // 笔试排名
                    rankCategory: Math.random() > 0.3 ? ['大围', '中围', '小围'][Math.floor(Math.random() * 3)] : null, // 大中小围
                    className: selectedClass.name,
                    isAgreement: Math.random() > 0.5 ? '协议' : '非协议',
                    discounts: getRandomDiscounts(), // 所享优惠（数组）
                    discountAmount: discountAmount,
                    referrerName: Math.random() > 0.6 ? `推荐人${Math.floor(Math.random() * 100)}` : null, // 推荐老学员
                    totalFee: selectedClass.fee,
                    actualFee: actualFee,
                    writtenScoreImage: `/images/score_${i}.jpg`, // 模拟笔试成绩图片路径
                    email: `student${i}@example.com`,
                    projectId: project.id,
                    projectName: project.name,
                    classId: selectedClass.id,
                    education: educations[Math.floor(Math.random() * educations.length)],
                    workplace: `单位${i}`,
                    address: `地址${i}号`,
                    remarks: Math.random() > 0.5 ? `备注信息${i}` : '',
                    actualFee: actualFee,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    paymentStatus: paymentStatuses[Math.floor(Math.random() * paymentStatuses.length)],
                    registrationTime: registrationTime.toISOString().slice(0, 19).replace('T', ' '),
                    approver: Math.random() > 0.5 ? '管理员' : '',
                    approveTime: Math.random() > 0.5 ? new Date(registrationTime.getTime() + Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 19).replace('T', ' ') : ''
                });
            }
            return mockData.sort((a, b) => new Date(b.registrationTime) - new Date(a.registrationTime));
        }

        // 加载项目数据
        function loadProjects() {
            allProjects = generateMockProjects();
            
            // 填充项目筛选选项
            const projectFilter = document.getElementById('projectFilter');
            const projectSelect = document.getElementById('projectId');
            
            allProjects.forEach(project => {
                // 筛选选项
                const option1 = document.createElement('option');
                option1.value = project.id;
                option1.textContent = project.name;
                projectFilter.appendChild(option1);
                
                // 表单选项
                const option2 = document.createElement('option');
                option2.value = project.id;
                option2.textContent = project.name;
                projectSelect.appendChild(option2);
            });
        }

        // 加载班型数据
        function loadClasses() {
            allClasses = generateMockClasses();
            
            // 填充班型筛选选项
            const classFilter = document.getElementById('classFilter');
            allClasses.forEach(classItem => {
                const option = document.createElement('option');
                option.value = classItem.id;
                option.textContent = classItem.name;
                classFilter.appendChild(option);
            });
        }

        // 加载项目对应的班型
        function loadProjectClasses() {
            const projectId = parseInt(document.getElementById('projectId').value);
            const classSelect = document.getElementById('classId');
            
            // 清空班型选项
            classSelect.innerHTML = '<option value="">请选择班型</option>';
            
            if (projectId) {
                const projectClasses = allClasses.filter(c => c.projectId === projectId);
                projectClasses.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.type;
                    option.dataset.fee = classItem.fee;
                    classSelect.appendChild(option);
                });
            }
            
            calculateFee();
        }

        // 计算费用
        function calculateFee() {
            const classSelect = document.getElementById('classId');
            const selectedOption = classSelect.options[classSelect.selectedIndex];
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            if (selectedOption && selectedOption.dataset.fee) {
                const totalFee = parseFloat(selectedOption.dataset.fee);
                document.getElementById('totalFee').value = totalFee.toFixed(2);
                document.getElementById('actualFee').value = Math.max(0, totalFee - discountAmount).toFixed(2);
            } else {
                document.getElementById('totalFee').value = '';
                document.getElementById('actualFee').value = '';
            }
        }

        // 加载报名数据
        function loadRegistrations() {
            allRegistrations = generateMockRegistrations();
            filteredRegistrations = [...allRegistrations];
            totalItems = filteredRegistrations.length;
            renderTable();
            updatePagination();
            updateStatistics();
        }

        // 更新统计信息
        function updateStatistics() {
            const total = allRegistrations.length;
            const pending = allRegistrations.filter(r => r.status === 'pending').length;
            const approved = allRegistrations.filter(r => r.status === 'approved' || r.status === 'paid').length;
            const totalRevenue = allRegistrations
                .filter(r => r.paymentStatus === 'paid')
                .reduce((sum, r) => sum + r.actualFee, 0);
            
            animateCounter('totalRegistrations', total);
            animateCounter('pendingRegistrations', pending);
            animateCounter('approvedRegistrations', approved);
            document.getElementById('totalRevenue').textContent = '¥' + totalRevenue.toLocaleString();
        }

        // 数字动画
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const duration = 800;
            const increment = targetValue / (duration / 16);
            let currentValue = 0;

            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(currentValue);
            }, 16);
        }

        // 获取状态信息
        function getStatusInfo(status) {
            switch(status) {
                case 'pending':
                    return { text: '待审核', class: 'status-warning' };
                case 'approved':
                    return { text: '已通过', class: 'status-active' };
                case 'rejected':
                    return { text: '已拒绝', class: 'status-inactive' };
                case 'paid':
                    return { text: '已缴费', class: 'status-success' };
                default:
                    return { text: status, class: 'status-pending' };
            }
        }

        // 获取缴费状态信息
        function getPaymentStatusInfo(status) {
            switch(status) {
                case 'unpaid':
                    return { text: '未缴费', class: 'status-warning' };
                case 'partial':
                    return { text: '部分缴费', class: 'status-pending' };
                case 'paid':
                    return { text: '已缴费', class: 'status-success' };
                case 'refunded':
                    return { text: '已退费', class: 'status-inactive' };
                default:
                    return { text: status, class: 'status-pending' };
            }
        }

        // 获取大中小围颜色
        function getRankCategoryColor(category) {
            switch(category) {
                case '大围':
                    return '#ff4d4f';
                case '中围':
                    return '#faad14';
                case '小围':
                    return '#52c41a';
                default:
                    return '#999';
            }
        }

        // 查看图片
        function viewImage(imageSrc, title) {
            // 创建模态框显示大图
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <h3 style="color: white; margin-bottom: 10px; text-align: center;">${title}</h3>
                    <img src="${imageSrc}" style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px;">
                    <div style="position: absolute; top: 10px; right: 10px;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #ff4d4f; color: white; border: none; border-radius: 50%; 
                                       width: 30px; height: 30px; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                </div>
            `;
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            document.body.appendChild(modal);
        }

        // 渲染表格
        function renderTable() {
            const tbody = document.getElementById('registrationTableBody');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredRegistrations.slice(start, end);

            tbody.innerHTML = pageData.map(registration => {
                const statusInfo = getStatusInfo(registration.status);
                
                // 处理优惠标签显示
                const discountTags = registration.discounts && registration.discounts.length > 0 
                    ? registration.discounts.map(discount => 
                        `<span style="background: #f0f8f0; color: #52c41a; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-right: 3px;">${discount}</span>`
                      ).join('')
                    : '<span style="color: #999; font-size: 12px;">无</span>';
                
                return `
                    <tr>
                        <td><input type="checkbox" class="registration-checkbox" value="${registration.id}"></td>
                        <td><strong>${registration.id}</strong></td>
                        <td>
                            <div style="font-weight: bold;">${registration.studentName}</div>
                        </td>
                        <td>
                            <span style="color: #3498db;">${registration.wechat}</span>
                        </td>
                        <td>
                            <span style="font-weight: 500;">${registration.phone}</span>
                        </td>
                        <td>
                            <div style="font-size: 12px; margin-bottom: 2px;">${registration.idCard}</div>
                            <img src="${registration.idCardImage}" style="width: 30px; height: 20px; object-fit: cover; border-radius: 2px; cursor: pointer;" 
                                 onclick="viewImage('${registration.idCardImage}', '身份证图片')" title="点击查看身份证图片">
                        </td>
                        <td>
                            <span style="background: #ecf0f1; color: #34495e; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${registration.positionCode}</span>
                        </td>
                        <td>
                            <div>${registration.positionName}</div>
                        </td>
                        <td><strong style="color: #1890ff;">${registration.recruitCount}</strong></td>
                        <td>
                            ${registration.writtenRank ? `<strong style="color: #f39c12;">${registration.writtenRank}</strong>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            ${registration.rankCategory ? `<span style="background: ${getRankCategoryColor(registration.rankCategory)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">${registration.rankCategory}</span>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            <div style="font-size: 13px; font-weight: 500;">${registration.className}</div>
                        </td>
                        <td>
                            <span style="background: ${registration.isAgreement === '协议' ? '#e6f7ff' : '#fff7e6'}; color: ${registration.isAgreement === '协议' ? '#1890ff' : '#fa8c16'}; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${registration.isAgreement}</span>
                        </td>
                        <td>
                            <div style="line-height: 1.3;">${discountTags}</div>
                        </td>
                        <td>
                            <strong style="color: #52c41a;">¥${registration.discountAmount}</strong>
                        </td>
                        <td>
                            ${registration.referrerName ? `<span style="font-size: 12px;">${registration.referrerName}</span>` : '<span style="color: #999;">无</span>'}
                        </td>
                        <td>
                            <strong style="color: #fa541c;">¥${registration.totalFee}</strong>
                        </td>
                        <td>
                            <div style="font-size: 12px; margin-bottom: 2px;">¥${registration.actualFee}</div>
                            <img src="${registration.writtenScoreImage}" style="width: 30px; height: 20px; object-fit: cover; border-radius: 2px; cursor: pointer;" 
                                 onclick="viewImage('${registration.writtenScoreImage}', '笔试成绩图片')" title="点击查看笔试成绩图片">
                        </td>
                        <td>
                            <img src="${registration.paymentImage}" style="width: 30px; height: 20px; object-fit: cover; border-radius: 2px; cursor: pointer;" 
                                 onclick="viewImage('${registration.paymentImage}', '转账截图')" title="点击查看转账截图">
                        </td>
                        <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewAndEditDetail(${registration.id})" title="查看/编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${registration.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveRegistration(${registration.id})" title="通过">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="rejectRegistration(${registration.id})" title="拒绝">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteRegistration(${registration.id})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // 更新批量审核按钮状态
            updateBatchApproveButton();
        }

        // 更新分页信息
        function updatePagination() {
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalItems);
            
            document.getElementById('startRecord').textContent = start;
            document.getElementById('endRecord').textContent = end;
            document.getElementById('totalRecords').textContent = totalItems;
        }

        // 处理搜索框回车事件
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchRegistrations();
            }
        }

        // 搜索报名
        function searchRegistrations() {
            applyFilters();
        }

        // 筛选报名
        function filterRegistrations() {
            applyFilters();
        }

        // 应用筛选条件
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredRegistrations = allRegistrations.filter(registration => {
                const matchesSearch = !searchTerm || 
                    registration.studentName.toLowerCase().includes(searchTerm) ||
                    registration.phone.includes(searchTerm) ||
                    registration.wechat.toLowerCase().includes(searchTerm) ||
                    registration.openid.toLowerCase().includes(searchTerm) ||
                    registration.positionName.toLowerCase().includes(searchTerm);
                
                const matchesProject = !projectFilter || registration.projectId.toString() === projectFilter;
                const matchesClass = !classFilter || registration.classId.toString() === classFilter;
                const matchesStatus = !statusFilter || registration.status === statusFilter;
                
                return matchesSearch && matchesProject && matchesClass && matchesStatus;
            });
            
            totalItems = filteredRegistrations.length;
            currentPage = 1;
            renderTable();
            updatePagination();
        }

        // 显示新增报名模态框
        function showAddRegistrationModal() {
            editingRegistrationId = null;
            document.getElementById('registrationModalTitle').textContent = '新增报名';
            document.getElementById('registrationForm').reset();
            document.getElementById('registrationModal').style.display = 'block';
        }

        // 关闭报名模态框
        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            editingRegistrationId = null;
        }

  
        // 保存报名
        function saveRegistration() {
            const formData = {
                studentName: document.getElementById('studentName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                idCard: document.getElementById('idCard').value.trim(),
                email: document.getElementById('email').value.trim(),
                projectId: parseInt(document.getElementById('projectId').value),
                classId: parseInt(document.getElementById('classId').value),
                education: document.getElementById('education').value,
                workplace: document.getElementById('workplace').value.trim(),
                address: document.getElementById('address').value.trim(),
                remarks: document.getElementById('remarks').value.trim(),
                totalFee: parseFloat(document.getElementById('totalFee').value),
                discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
                actualFee: parseFloat(document.getElementById('actualFee').value),
                status: document.getElementById('status').value,
                paymentStatus: document.getElementById('paymentStatus').value
            };

            // 表单验证
            if (!formData.studentName) {
                alert('请输入学员姓名');
                return;
            }
            if (!formData.phone || !/^1[3-9]\d{9}$/.test(formData.phone)) {
                alert('请输入正确的手机号');
                return;
            }
            if (!formData.idCard) {
                alert('请输入身份证号');
                return;
            }
            if (!formData.projectId) {
                alert('请选择报名项目');
                return;
            }
            if (!formData.classId) {
                alert('请选择班型');
                return;
            }

            // 检查重复身份证号
            const existing = allRegistrations.find(r => r.idCard === formData.idCard && r.id !== editingRegistrationId);
            if (existing) {
                alert('该身份证号已存在报名记录');
                return;
            }

            // 获取项目和班型信息
            const project = allProjects.find(p => p.id === formData.projectId);
            const classItem = allClasses.find(c => c.id === formData.classId);

            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

            if (editingRegistrationId) {
                // 编辑模式
                const registrationIndex = allRegistrations.findIndex(r => r.id === editingRegistrationId);
                allRegistrations[registrationIndex] = {
                    ...allRegistrations[registrationIndex],
                    ...formData,
                    projectName: project.name,
                    className: classItem.name
                };
                showNotification('报名信息更新成功', 'success');
            } else {
                // 新增模式
                const newRegistration = {
                    id: Math.max(...allRegistrations.map(r => r.id), 0) + 1,
                    ...formData,
                    projectName: project.name,
                    className: classItem.name,
                    registrationTime: now,
                    approver: '',
                    approveTime: ''
                };
                allRegistrations.unshift(newRegistration);
                showNotification('报名创建成功', 'success');
            }

            closeRegistrationModal();
            applyFilters();
            updateStatistics();
        }

        // 更新优惠金额（根据选择的优惠类型自动计算）
        function updateDiscountAmount() {
            const discountSelect = document.getElementById('detailDiscountSelect');
            const selectedOption = discountSelect.options[discountSelect.selectedIndex];
            const amount = selectedOption.dataset.amount || 0;
            document.getElementById('detailDiscountAmount').value = amount;
            
            // 重新计算实际学费
            const totalFee = parseFloat(document.getElementById('detailTotalFee').value) || 0;
            const actualFee = Math.max(0, totalFee - parseFloat(amount));
            document.getElementById('detailActualFee').value = actualFee;
        }

        // 查看和编辑详情（合并功能）
        function viewAndEditDetail(registrationId) {
            console.log('查看和编辑详情 ID:', registrationId);
            
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) {
                console.error('未找到报名记录:', registrationId);
                alert('未找到报名记录');
                return;
            }

            console.log('找到报名记录:', registration);

            // 检查模态框是否存在
            const modal = document.getElementById('detailModal');
            if (!modal) {
                console.error('详情模态框不存在');
                alert('页面元素加载不完整，请刷新页面重试');
                return;
            }

            try {
                // 设置模态框标题
                document.getElementById('detailModalTitle').textContent = `报名详情 - ${registration.studentName}`;

                // 填充表单数据
                document.getElementById('detailId').value = registration.id;
                document.getElementById('detailOpenId').value = registration.openid;
                document.getElementById('detailStudentName').value = registration.studentName;
                document.getElementById('detailWechat').value = registration.wechat;
                document.getElementById('detailPhone').value = registration.phone;
                document.getElementById('detailPositionCode').value = registration.positionCode;
                document.getElementById('detailPositionName').value = registration.positionName;
                document.getElementById('detailRecruitCount').value = registration.recruitCount;
                document.getElementById('detailWrittenRank').value = registration.writtenRank || '';
                document.getElementById('detailRankCategory').value = registration.rankCategory || '';
                document.getElementById('detailClassName').value = registration.className;
                document.getElementById('detailIsAgreement').value = registration.isAgreement;
                document.getElementById('detailDiscountAmount').value = registration.discountAmount;
                document.getElementById('detailReferrerName').value = registration.referrerName || '';
                document.getElementById('detailTotalFee').value = registration.totalFee;
                document.getElementById('detailActualFee').value = registration.actualFee;
                document.getElementById('detailStatus').value = registration.status;
                document.getElementById('detailPaymentStatus').value = registration.paymentStatus;

                // 处理优惠选择
                const discountSelect = document.getElementById('detailDiscountSelect');
                if (registration.discounts && registration.discounts.length > 0) {
                    // 选择第一个匹配的优惠类型
                    const matchingOption = Array.from(discountSelect.options).find(option => 
                        registration.discounts.includes(option.value)
                    );
                    if (matchingOption) {
                        discountSelect.value = matchingOption.value;
                        updateDiscountAmount(); // 更新优惠金额
                    }
                } else {
                    discountSelect.value = '';
                }

                // 设置图片和备注
                document.getElementById('detailIdCardImage').src = registration.idCardImage;
                document.getElementById('detailWrittenScoreImage').src = registration.writtenScoreImage;
                document.getElementById('detailPaymentImage').src = registration.paymentImage;
                document.getElementById('detailRemarks').value = registration.remarks || '';

                // 根据审核状态显示审核按钮
                const approveBtn = document.getElementById('approveDetailBtn');
                const rejectBtn = document.getElementById('rejectDetailBtn');
                if (registration.status === 'pending') {
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }

                // 存储当前编辑的报名ID
                document.getElementById('detailForm').dataset.registrationId = registrationId;

                console.log('显示详情模态框');
                modal.style.display = 'block';
                
                // 确保模态框确实显示了
                setTimeout(() => {
                    if (modal.style.display !== 'block') {
                        console.error('详情模态框未能正常显示');
                        modal.style.display = 'block';
                    }
                }, 50);
                
            } catch (error) {
                console.error('显示详情时发生错误:', error);
                alert('显示详情时发生错误，请刷新页面重试');
            }
        }

        // 关闭详情模态框
        function closeDetailModal() {
            console.log('关闭详情模态框');
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('详情模态框已关闭');
            } else {
                console.error('无法找到详情模态框元素');
            }
        }

        // 保存详情修改
        function saveDetailChanges() {
            const registrationId = parseInt(document.getElementById('detailForm').dataset.registrationId);
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            // 获取表单数据（不包括只读字段）
            const formData = {
                studentName: document.getElementById('detailStudentName').value.trim(),
                wechat: document.getElementById('detailWechat').value.trim(),
                writtenRank: parseInt(document.getElementById('detailWrittenRank').value) || null,
                className: document.getElementById('detailClassName').value.trim(),
                isAgreement: document.getElementById('detailIsAgreement').value,
                discountAmount: parseFloat(document.getElementById('detailDiscountAmount').value) || 0,
                referrerName: document.getElementById('detailReferrerName').value.trim(),
                actualFee: parseFloat(document.getElementById('detailActualFee').value) || 0,
                status: document.getElementById('detailStatus').value,
                paymentStatus: document.getElementById('detailPaymentStatus').value,
                remarks: document.getElementById('detailRemarks').value.trim()
            };

            // 表单验证
            if (!formData.studentName) {
                alert('请输入学员姓名');
                return;
            }
            if (!formData.className) {
                alert('请输入所报班型');
                return;
            }

            // 更新注册信息
            Object.assign(registration, formData);

            showNotification('报名信息修改成功', 'success');
            renderTable();
            updateStatistics();
        }

        // 从详情页面审核通过
        function approveFromDetail() {
            const registrationId = parseInt(document.getElementById('detailForm').dataset.registrationId);
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            if (confirm(`确定要通过 ${registration.studentName} 的报名申请吗？`)) {
                registration.status = 'approved';
                registration.approver = '管理员';
                registration.approveTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
                
                // 更新界面
                document.getElementById('detailStatus').value = 'approved';
                document.getElementById('approveDetailBtn').style.display = 'none';
                document.getElementById('rejectDetailBtn').style.display = 'none';
                
                showNotification('报名审核通过', 'success');
                renderTable();
                updateStatistics();
            }
        }

        // 从详情页面审核拒绝
        function rejectFromDetail() {
            const registrationId = parseInt(document.getElementById('detailForm').dataset.registrationId);
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            const reason = prompt('请输入拒绝原因：');
            if (reason !== null) {
                registration.status = 'rejected';
                registration.approver = '管理员';
                registration.approveTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
                registration.remarks = (registration.remarks ? registration.remarks + '\n' : '') + `拒绝原因：${reason}`;
                
                // 更新界面
                document.getElementById('detailStatus').value = 'rejected';
                document.getElementById('approveDetailBtn').style.display = 'none';
                document.getElementById('rejectDetailBtn').style.display = 'none';
                
                showNotification('报名已拒绝', 'warning');
                renderTable();
                updateStatistics();
            }
        }

        // 审核通过
        function approveRegistration(registrationId) {
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            if (confirm(`确定要通过 ${registration.studentName} 的报名申请吗？`)) {
                registration.status = 'approved';
                registration.approver = '管理员';
                registration.approveTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
                showNotification('报名审核通过', 'success');
                renderTable();
                updateStatistics();
            }
        }

        // 审核拒绝
        function rejectRegistration(registrationId) {
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            const reason = prompt('请输入拒绝原因：');
            if (reason !== null) {
                registration.status = 'rejected';
                registration.approver = '管理员';
                registration.approveTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
                registration.remarks = (registration.remarks ? registration.remarks + '\n' : '') + `拒绝原因：${reason}`;
                showNotification('报名已拒绝', 'warning');
                renderTable();
                updateStatistics();
            }
        }

        // 删除报名
        function deleteRegistration(registrationId) {
            const registration = allRegistrations.find(r => r.id === registrationId);
            if (!registration) return;

            if (confirm(`确定要删除 ${registration.studentName} 的报名记录吗？`)) {
                allRegistrations = allRegistrations.filter(r => r.id !== registrationId);
                showNotification('报名记录删除成功', 'success');
                applyFilters();
                updateStatistics();
            }
        }

        // 批量选择
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.registration-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBatchApproveButton();
        }

        // 更新批量审核按钮
        function updateBatchApproveButton() {
            const checked = document.querySelectorAll('.registration-checkbox:checked').length;
            const batchBtn = document.getElementById('batchApproveBtn');
            batchBtn.disabled = checked === 0;
            batchBtn.innerHTML = checked > 0 ? `<i class="fas fa-check"></i> 批量审核 (${checked})` : '<i class="fas fa-check"></i> 批量审核';
        }

        // 监听复选框变化
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('registration-checkbox')) {
                updateBatchApproveButton();
            }
        });

        // 批量审核
        function batchApprove() {
            const checkboxes = document.querySelectorAll('.registration-checkbox:checked');
            if (checkboxes.length === 0) return;

            if (confirm(`确定要批量审核通过选中的 ${checkboxes.length} 个报名申请吗？`)) {
                const idsToApprove = Array.from(checkboxes).map(cb => parseInt(cb.value));
                const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
                
                allRegistrations.forEach(registration => {
                    if (idsToApprove.includes(registration.id) && registration.status === 'pending') {
                        registration.status = 'approved';
                        registration.approver = '管理员';
                        registration.approveTime = now;
                    }
                });
                
                showNotification(`成功审核通过 ${checkboxes.length} 个报名申请`, 'success');
                renderTable();
                updateStatistics();
                document.getElementById('selectAll').checked = false;
            }
        }

        // 导出报名数据
        function exportRegistrations() {
            const csvContent = generateCSV(filteredRegistrations);
            downloadCSV(csvContent, 'registrations.csv');
            showNotification('报名数据导出成功', 'success');
        }

        // 生成CSV内容
        function generateCSV(data) {
            const headers = ['报名ID', '学员姓名', '手机号', '身份证号', '邮箱', '报名项目', '选择班型', '学历', '工作单位', '应缴费用', '优惠金额', '实缴费用', '审核状态', '缴费状态', '报名时间'];
            const rows = data.map(registration => {
                const statusInfo = getStatusInfo(registration.status);
                const paymentInfo = getPaymentStatusInfo(registration.paymentStatus);
                return [
                    registration.id,
                    registration.studentName,
                    registration.phone,
                    registration.idCard,
                    registration.email || '',
                    registration.projectName,
                    registration.className,
                    registration.education || '',
                    registration.workplace || '',
                    registration.totalFee,
                    registration.discountAmount,
                    registration.actualFee,
                    statusInfo.text,
                    paymentInfo.text,
                    registration.registrationTime
                ];
            });
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        // 下载CSV文件
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // 导入相关功能
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
        }

        function selectImportFile() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('importSummary').innerHTML = `
                <p>文件名：${file.name}</p>
                <p>文件大小：${(file.size / 1024).toFixed(2)} KB</p>
                <p>准备导入报名数据...</p>
            `;
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('importBtn').disabled = false;
        }

        function importRegistrations() {
            showNotification('正在导入报名数据...', 'info');
            setTimeout(() => {
                showNotification('报名数据导入成功', 'success');
                closeImportModal();
                loadRegistrations();
            }, 2000);
        }

        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(totalItems / pageSize);
            
            if (page === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (page === 'next' && currentPage < totalPages) {
                currentPage++;
            } else if (typeof page === 'number' && page >= 1 && page <= totalPages) {
                currentPage = page;
            }
            
            renderTable();
            updatePagination();
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 10001;
                animation: slideInRight 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#52c41a';
                    break;
                case 'error':
                    notification.style.background = '#ff4d4f';
                    break;
                case 'warning':
                    notification.style.background = '#faad14';
                    break;
                default:
                    notification.style.background = '#1890ff';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 添加模态框优化样式
        const modalOptimizeStyle = document.createElement('style');
        modalOptimizeStyle.textContent = `
            /* 确保模态框在各种屏幕尺寸下都能正确显示 */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                overflow: auto;
            }
            
            #detailModal .modal-content {
                display: flex !important;
                flex-direction: column !important;
                max-height: 95vh !important;
                margin: 2vh auto !important;
                overflow: hidden !important;
            }
            
            #detailModal .modal-body {
                flex: 1 !important;
                overflow-y: auto !important;
                max-height: none !important;
            }
            
            #detailModal .modal-footer {
                flex-shrink: 0 !important;
                position: relative !important;
            }
            
            /* 移动端优化 */
            @media (max-width: 768px) {
                #detailModal .modal-content {
                    width: 98% !important;
                    margin: 1vh auto !important;
                    max-height: 98vh !important;
                }
                
                #detailModal .modal-body {
                    padding: 10px !important;
                }
                
                #detailModal .form-group {
                    margin-bottom: 15px !important;
                }
                
                #detailModal div[style*="grid-template-columns"] {
                    grid-template-columns: 1fr !important;
                    gap: 10px !important;
                }
            }
        `;
        document.head.appendChild(modalOptimizeStyle);
    </script>
</body>
</html>
